<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>lasRui | Interactive pipeline builder</title>
  <meta name="description" content="Simple Web App to build pipelines for the lasR software.">
</head>

<body>
  <script src="drawflow.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
  <link rel="stylesheet" type="text/css" href="drawflow.css">
  <link rel="stylesheet" type="text/css" href="beautiful.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>

  <style>
    .connectors {
      display: flex;
      gap: 4%;
    }

    .iconnectors,
    .oconnectors {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .iconnectors {
      justify-content: flex-start;
    }

    .oconnectors {
      justify-content: flex-start;
      text-align: right;
    }

    .iconnectors p,
    .oconnectors p {
      margin: 0;
      margin-bottom: 8px;
      font-size: inherit;
      font-family: inherit;
      color: inherit;
    }

    .oconnectors p {
      margin-right: 10px;
    }

    .oconnectors span {
      margin-right: 5px;
    }

    .iconnectors span {
      margin-left: 20px;
    }

    hr {
      border: none;
      height: 2px;
      background-color: #ccc;
      margin: 10px 0;
    }

    .category {
      line-height: 50px;
      border-bottom: 1px solid var(--border-color);
      padding-left: 20px;
    }

    .subcategory {
      display: none;
    }

    .toggle-btn {
      cursor: pointer;
    }

    .json-content {
      font-size: 10px;
      /* Adjust font size as needed */
      width: 400px;
      max-height: 500px;
      /* Set maximum height */
      overflow: auto;
      /* Add scroll if content overflows */
      background-color: #f5f5f5;
      /* Light background color */
      padding: 10px;
      /* Padding for better readability */
      border: 1px solid #ddd;
      /* Border for visual separation */
      white-space: pre-wrap;
      /* Preserve white space and wrap long lines */
      line-height: 1.5;
      /* Adjust line height for better readability */
      text-align: left;
    }

    pre {
      outline: 1px solid #ccc;
      padding: 5px;
      margin: 5px;
    }

    .string {
      color: green;
    }

    .number {
      color: darkorange;
    }

    .boolean {
      color: blue;
    }

    .null {
      color: magenta;
    }

    .key {
      color: red;
    }
  </style>

  <header>
    <h2>lasR App</h2>
    <!--<div class="github-link"><a href="https://github.com/jerosoler/Drawflow" target="_blank"><i class="fab fa-github fa-3x"></i></a></div>
    <div class="them-edit-link"><a href="https://jerosoler.github.io/drawflow-theme-generator/" target="_blank">🎨</a></div>-->
  </header>

  <div class="wrapper">

    <!-- Dragable stage side column -->
    <div class="col">

      <!-- madatory -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Mandatory stages</span>
        </div>
        <div class="subcategory">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="processing_options">
            <i class="fas fa-shapes"></i><span> Processing options</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="reader_las">
            <i class="fas fa-stream"></i><span> reader_las</span>
          </div>
        </div>
      </div>

      <!-- writers -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Writers</span>
        </div>
        <div class="subcategory">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="write_las">
            <i class="fas fa-file-pen"></i><span> write_las</span>
          </div>
        </div>
      </div>

      <!-- Raster -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Raster</span>
        </div>
        <div class="subcategory">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="rasterize">
            <i class="fas fa-border-all"></i><span> rasterize</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="rasterize_tin">
            <i class="fas fa-border-all"></i><span> rasterize tin</span>
          </div>
        </div>
      </div>

      <!-- Mesh-->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Mesh</span>
        </div>
        <div class="subcategory">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="triangulate">
            <i class="fas fa-square-caret-up"></i><span> triangulate</span>
          </div>
        </div>
      </div>

      <!-- Transform -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Transform</span>
        </div>
        <div class="subcategory">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transform_with">
            <i class="fas fa-exchange-alt"></i><span> transform_with</span>
          </div>
        </div>
      </div>

      <!-- Classify -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Classify</span>
        </div>
        <div class="subcategory">

        </div>
      </div>

      <!-- Tree segmentation -->
      <div class="category">
        <div class="toggle-btn">
          <i class="fas fa-chevron-right"></i><span> Tree segmentation</span>
        </div>
        <div class="subcategory">

        </div>
      </div>

    </div>

    <div class="col-right">
      <!--<div class="menu">
        <ul>
          <li onclick="editor.changeModule('Home'); changeModule(event);" class="selected">Home</li>
          <li onclick="editor.changeModule('Other'); changeModule(event);">Other Module</li>
        </ul>
      </div>-->
      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">

        <!--
        <div class="btn-show" onclick="Swal.fire({ title: 'Export',
        html: '<pre><code>'+JSON.stringify(editor.export(), null,4)+'</code></pre>'
        })">Show</div>
        <div class="btn-export" onclick="downloadJSON()">Export</div>
        <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>
        -->
        <div class="btn-lock">
          <i id="lock" class="fas fa-lock" onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
          <i id="unlock" class="fas fa-lock-open" onclick="editor.editor_mode='edit'; changeMode('unlock');"
            style="display:none;"></i>
        </div>
        <div class="bar-zoom">
          <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
          <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
          <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('.toggle-btn').forEach(button => {
      button.addEventListener('click', () => {
        const subcategory = button.nextElementSibling;
        if (subcategory.style.display === 'none' || subcategory.style.display === '') {
          subcategory.style.display = 'block';
          button.querySelector('i').classList.remove('fa-chevron-right');
          button.querySelector('i').classList.add('fa-chevron-down');
        }
        else {
          subcategory.style.display = 'none';
          button.querySelector('i').classList.remove('fa-chevron-down');
          button.querySelector('i').classList.add('fa-chevron-right');
        }
      });
    });
  </script>

  <script>
    function downloadJSON() {
      const jsonData = JSON.stringify(editor.export(), null, 4); // Get the JSON data from the editor
      const blob = new Blob([jsonData], { type: 'application/json' }); // Create a Blob object from the JSON data
      const link = document.createElement('a'); // Create a link element
      link.download = 'exported_data.json'; // Set the download attribute with a filename
      link.href = URL.createObjectURL(blob); // Create a URL for the Blob and set it as the href attribute
      document.body.appendChild(link); // Append the link to the document body (required for Firefox)
      link.click(); // Programmatically click the link to trigger the download
      document.body.removeChild(link); // Remove the link from the document
    }
  </script>

  <script>
    var id = document.getElementById("drawflow");
    const editor = new Drawflow(id);
    editor.reroute = true;
    editor.useuuid = true;
    const dataToImport = { "drawflow": { "Home": { "data": { "01ea4b57-5f56-4a44-a415-3be61dc990bd": { "id": "01ea4b57-5f56-4a44-a415-3be61dc990bd", "name": "processing_options", "data": { "files": "#system.file(\"extdata\", \"Topography.las\", package = \"lasR\")#", "ncores": "4" }, "class": "processing_options", "html": "\n        <div>\n            <div class=\"title-box\"><i class=\"fas fa-shapes\"></i> processing_options</div>\n            <div class=\"box\">\n            <div class=\"connectors\">\n                <div class=\"oconnectors\"><p><span>files </span><i class=\"fas fa-file\"></i></p></div>\n            </div>\n            <hr/>\n            <div class=\"parameters\">\n              <p>files: <input type=\"text\" value=\"plop\" df-files></p>\n              <p>ncores: <input type=\"text\" df-ncores></p>\n              <p>strategy:\n                 <select df-strategy>\n                    <option value=\"concurrent-points\">concurrent-points</option>\n                    <option value=\"concurrent-files\">concurrent-files</option>\n                    <option value=\"nested\">nested</option>\n                    <option value=\"sequential\">sequential</option>\n                 </select>\n              </p>\n            </div>\n            </div>\n        </div>\n          ", "typenode": false, "inputs": {}, "outputs": { "output_1": { "connections": [{ "node": "4a28317c-d9be-451f-b8f0-c681f777997c", "output": "input_1" }] } }, "pos_x": 60, "pos_y": 207 }, "4a28317c-d9be-451f-b8f0-c681f777997c": { "id": "4a28317c-d9be-451f-b8f0-c681f777997c", "name": "reader_las", "data": { "filter": "-keep_first" }, "class": "reader_las", "html": "\n        <div>\n            <div class=\"title-box\"><i class=\"fas fa-stream\"></i> reader_las</div>\n            <div class=\"box\">\n            <div class=\"connectors\">\n                <div class=\"iconnectors\"><p><i class=\"fas fa-file\"></i><span> files</span></p></div>\n                <div class=\"oconnectors\"><p><span>cloud </span><i class=\"fas fa-spinner\"></i></p></div>\n            </div>\n            <hr/>\n            <div class=\"parameters\">\n                <p>filter: <input type=\"text\" df-filter></p>\n            </div>\n            </div>\n        </div>\n        ", "typenode": false, "inputs": { "input_1": { "connections": [{ "node": "01ea4b57-5f56-4a44-a415-3be61dc990bd", "input": "output_1" }] } }, "outputs": { "output_1": { "connections": [{ "node": "047bb7db-2734-4d89-93a3-4b632bd63cf3", "output": "input_1" }, { "node": "eb16041f-c2ff-41e4-8948-33cf6ea3e70a", "output": "input_1" }] } }, "pos_x": 379, "pos_y": 205 }, "047bb7db-2734-4d89-93a3-4b632bd63cf3": { "id": "047bb7db-2734-4d89-93a3-4b632bd63cf3", "name": "rasterize", "data": { "res": "2", "method": "z_max", "output": "#temptif()#" }, "class": "rasterize", "html": "\n        <div>\n            <div class=\"title-box\"><i class=\"fas fa-border-all\"></i> rasterize</div>\n            <div class=\"box\">\n            <div class=\"connectors\">\n                <div class=\"iconnectors\">\n                    <p>cloud | mesh</p>\n                </div>\n                <div class=\"oconnectors\"><p>raster</p></div>\n            </div>\n            <hr/>\n            <div class=\"parameters\">\n              <p>res: <input type=\"text\" df-res></p>\n              <p>operators: <input type=\"text\" df-method></p>\n              <p>filter: <input type=\"text\" df-filter></p>\n              <p>ofile:  <input type=\"text\" df-output></p>\n              <p>default value: <input type=\"text\" df-default_value>\n            </div>\n            </div>\n        </div>\n          ", "typenode": false, "inputs": { "input_1": { "connections": [{ "node": "4a28317c-d9be-451f-b8f0-c681f777997c", "input": "output_1" }] } }, "outputs": { "output_1": { "connections": [] } }, "pos_x": 712, "pos_y": 343 }, "eb16041f-c2ff-41e4-8948-33cf6ea3e70a": { "id": "eb16041f-c2ff-41e4-8948-33cf6ea3e70a", "name": "rasterize", "data": { "res": "20", "method": "z_mean", "output": "#temptif()#" }, "class": "rasterize", "html": "\n        <div>\n            <div class=\"title-box\"><i class=\"fas fa-border-all\"></i> rasterize</div>\n            <div class=\"box\">\n            <div class=\"connectors\">\n                <div class=\"iconnectors\">\n                    <p>cloud | mesh</p>\n                </div>\n                <div class=\"oconnectors\"><p>raster</p></div>\n            </div>\n            <hr/>\n            <div class=\"parameters\">\n              <p>res: <input type=\"text\" df-res></p>\n              <p>operators: <input type=\"text\" df-method></p>\n              <p>filter: <input type=\"text\" df-filter></p>\n              <p>ofile:  <input type=\"text\" df-output></p>\n              <p>default value: <input type=\"text\" df-default_value>\n            </div>\n            </div>\n        </div>\n          ", "typenode": false, "inputs": { "input_1": { "connections": [{ "node": "4a28317c-d9be-451f-b8f0-c681f777997c", "input": "output_1" }] } }, "outputs": { "output_1": { "connections": [] } }, "pos_x": 974, "pos_y": -46 } } } } }
    editor.start();
    editor.import(dataToImport);

    /*
      var welcome = `
      <div>
        <div class="title-box">👏 Welcome!!</div>
        <div class="box">
          <p>Simple flow library <b>demo</b>
          <a href="https://github.com/jerosoler/Drawflow" target="_blank">Drawflow</a> by <b>Jero Soler</b></p><br>

          <p>Multiple input / outputs<br>
             Data sync nodes<br>
             Import / export<br>
             Modules support<br>
             Simple use<br>
             Type: Fixed or Edit<br>
             Events: view console<br>
             Pure Javascript<br>
          </p>
          <br>
          <p><b><u>Shortkeys:</u></b></p>
          <p>🎹 <b>Delete</b> for remove selected<br>
          💠 Mouse Left Click == Move<br>
          ❌ Mouse Right == Delete Option<br>
          🔍 Ctrl + Wheel == Zoom<br>
          📱 Mobile support<br>
          ...</p>
        </div>
      </div>
      `;
  */

    //editor.addNode(name, inputs, outputs, posx, posy, class, data, html);
    /*editor.addNode('welcome', 0, 0, 50, 50, 'welcome', {}, welcome );
    editor.addModule('Other');
    */

    // Events!
    editor.on('nodeCreated', function (id) {
      console.log("Node created " + id);
    })

    editor.on('nodeRemoved', function (id) {
      console.log("Node removed " + id);
    })

    editor.on('nodeSelected', function (id) {
      console.log("Node selected " + id);
    })

    editor.on('moduleCreated', function (name) {
      console.log("Module Created " + name);
    })

    editor.on('moduleChanged', function (name) {
      console.log("Module Changed " + name);
    })

    editor.on('connectionCreated', function (connection) {
      console.log('Connection created');
      console.log(connection);
    })

    editor.on('connectionRemoved', function (connection) {
      console.log('Connection removed');
      console.log(connection);
    })

    editor.on('mouseMove', function (position) {
      console.log('Position mouse x:' + position.x + ' y:' + position.y);
    })

    editor.on('nodeMoved', function (id) {
      console.log("Node moved " + id);
    })

    editor.on('zoom', function (zoom) {
      console.log('Zoom level ' + zoom);
    })

    editor.on('translate', function (position) {
      console.log('Translate x:' + position.x + ' y:' + position.y);
    })

    editor.on('addReroute', function (id) {
      console.log("Reroute added " + id);
    })

    editor.on('removeReroute', function (id) {
      console.log("Reroute removed " + id);
    })

    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false);
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;
    function positionMobile(ev) {
      mobile_last_move = ev;
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
        ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if (parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }

    }

    function addNodeToDrawFlow(name, pos_x, pos_y) {
      if (editor.editor_mode === 'fixed') {
        return false;
      }
      pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
      pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));


      switch (name) {
        case 'reader_las':
          var reader_las = `
        <div>
            <div class="title-box"><i class="fas fa-stream"></i> reader_las</div>
            <div class="box">
            <div class="connectors">
                <div class="oconnectors"><p><span>cloud </span><i class="fas fa-spinner"></i></p></div>
            </div>
            <hr/>
            <div class="parameters">
                <p>filter: <input type="text" df-filter></p>
            </div>
            </div>
        </div>
        `;
          editor.addNode('reader_las', 0, 1, pos_x, pos_y, 'reader_las', {}, reader_las);
          break;
        case 'write_las':
          var write_las = `
          <div>
            <div class="title-box"><i class="fas fa-file-pen"></i> write_las</div>
            <div class="box">
            <div class="connectors">
                <div class="iconnectors"><i class="fas fa-spinner"></i><p><span> cloud</span></p></div>
            </div>
            <hr/>
            <div class="parameters">
                <p>ofile: <input type="text" df-output></p>
                <p>filter: <input type="text" df-filter></p>
                <p>keep_buffer:
                <select df-channel>
                    <option value="false">false</option>
                    <option value="true">true</option>
                </select>
                </p>
            </div>
            </div>
          </div>
          `
          editor.addNode('write_las', 1, 0, pos_x, pos_y, 'write_las', {}, write_las);
          break;
        case 'triangulate':
          var triangulate = `
        <div>
            <div class="title-box"><i class="fas fa-square-caret-up"></i> triangulate</div>
            <div class="box">
            <div class="connectors">
                <div class="iconnectors">
                  <p><i class="fas fa-spinner"></i><span> cloud</span></p>
                </div>
                <div class="oconnectors">
                  <p><span>tin </span><i class="fas fa-recycle"></i></p>
                </div>
            </div>
            <hr/>
            <div class="parameters">
              <p>max_edge: <input type="text" df-max_edge value="0"></p>
              <p>filter: <input type="text" df-filter></p>
              <p>ofile: <input type="text" df-output></p>
              <p>use_attribute:
               <select df-use_attribute>
                    <option value="Z">Z</option>
                    <option value="Intensity">Intensity</option>
                </select></p>
            </div>
            </div>
        </div>
          `;
          editor.addNode('triangulate', 1, 1, pos_x, pos_y, 'triangulate', {}, triangulate);
          break;
        case 'transform_with':
          var transform_with = `
        <div>
            <div class="title-box"><i class="fas fa-exchange-alt"></i> transform_with</div>
            <div class="box">
                <div class="connectors">
                    <div class="iconnectors">
                      <p><i class="fas fa-spinner"></i><span> cloud</span></p>
                      <p>raster | tin</p>
                    </div>
                    <div class="oconnectors"><p><span>cloud </span><i class="fas fa-spinner"></i></p></div>
                </div>
                <hr/>
                <div class="parameters">
                  <p>operator:
                   <select df-operator>
                        <option value="-">-</option>
                        <option value="+">+</option>
                    </select> </p>
                  <p>store_in_attribute: <input type="text" df-store_in_attribute value="Z"></p>
                </div>
            </div>
         </div>
          `;
          editor.addNode('transform_with', 2, 1, pos_x, pos_y, 'transform_with', {}, transform_with);
          break;
        case 'rasterize':
          var rasterize = `
        <div>
            <div class="title-box"><i class="fas fa-border-all"></i> rasterize</div>
            <div class="box">
            <div class="connectors">
                <div class="iconnectors">
                    <p><i class="fas fa-spinner"></i><span> cloud</span></p>
                </div>
                <div class="oconnectors">
                  <p><span>raster </span><i class="fas fa-layer-group"></i></p>
                </div>
            </div>
            <hr/>
            <div class="parameters">
              <p>res: <input type="text" df-res></p>
              <p>operators: <input type="text" df-method></p>
              <p>filter: <input type="text" df-filter></p>
              <p>ofile:  <input type="text" df-output></p>
              <p>default value: <input type="text" df-default_value>
            </div>
            </div>
        </div>
          `;
          editor.addNode('rasterize', 1, 1, pos_x, pos_y, 'rasterize', {}, rasterize);
          break;
        case 'rasterize_tin':
          var rasterize_tin = `
        <div>
            <div class="title-box"><i class="fas fa-border-all"></i> rasterize tin</div>
            <div class="box">
            <div class="connectors">
                <div class="iconnectors">
                    <p><i class="fas fa-recycle"></i><span> tin</span></p>
                </div>
                <div class="oconnectors">
                  <p><span>raster </span><i class="fas fa-layer-group"></i></p>
                </div>
            </div>
            <hr/>
            <div class="parameters">
              <p>res: <input type="text" df-res></p>
              <p>filter: <input type="text" df-filter></p>
              <p>ofile:  <input type="text" df-output></p>
            </div>
            </div>
        </div>
          `;
          editor.addNode('rasterize', 1, 1, pos_x, pos_y, 'rasterize_tin', {}, rasterize_tin);
          break;
        case 'processing_options':
          var processing_options = `
        <div>
            <div class="title-box"><i class="fas fa-shapes"></i> Processing options</div>
            <div class="box">
            <div class="connectors">
            </div>
            <hr/>
            <div class="parameters">
              <p>files: <input type="text" df-files></p>
              <p>buffer: <input type="text" df-buffer></p>
              <p>chunk: <input type="text" df-chunk></p>
              <p>ncores: <input type="text" df-ncores></p>
              <p>strategy:
                 <select df-strategy>
                    <option value="concurrent-points">concurrent-points</option>
                    <option value="concurrent-files">concurrent-files</option>
                    <option value="nested">nested</option>
                    <option value="sequential">sequential</option>
                 </select>
              </p>
            </div>
            </div>
        </div>
          `;
          editor.addNode('processing_options', 0, 0, pos_x, pos_y, 'processing_options', {}, processing_options);
          break;
        default:
      }
    }

    var transform = '';
    function showpopup(e) {
      e.target.closest(".drawflow-node").style.zIndex = "9999";
      e.target.children[0].style.display = "block";
      //document.getElementById("modalfix").style.display = "block";

      //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
      transform = editor.precanvas.style.transform;
      editor.precanvas.style.transform = '';
      editor.precanvas.style.left = editor.canvas_x + 'px';
      editor.precanvas.style.top = editor.canvas_y + 'px';
      console.log(transform);

      //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
      //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
      editor.editor_mode = "fixed";

    }

    function closemodal(e) {
      e.target.closest(".drawflow-node").style.zIndex = "2";
      e.target.parentElement.parentElement.style.display = "none";
      //document.getElementById("modalfix").style.display = "none";
      editor.precanvas.style.transform = transform;
      editor.precanvas.style.left = '0px';
      editor.precanvas.style.top = '0px';
      editor.editor_mode = "edit";
    }

    function changeModule(event) {
      var all = document.querySelectorAll(".menu ul li");
      for (var i = 0; i < all.length; i++) {
        all[i].classList.remove('selected');
      }
      event.target.classList.add('selected');
    }

    function changeMode(option) {

      //console.log(lock.id);
      if (option == 'lock') {
        lock.style.display = 'none';
        unlock.style.display = 'block';
      } else {
        lock.style.display = 'block';
        unlock.style.display = 'none';
      }

    }

    window.addEventListener("message", function (event) {
      console.log('Receive message from external API...');

      if (event.data === "ShinyTriggerRun") {
        var data = editor.export();
        window.parent.postMessage({ type: 'ExportData', payload: JSON.stringify(data) }, '*'); // Post the data back to Shiny
      }
      else if (event.data === "ShinyTriggerClear") {
        editor.clearModuleSelected();
      }
      else if (event.data === "ShinyTriggerExport") {
        downloadJSON();
      }
      else if (event.data.type === "ShinyTriggerUpload") {
        const data = event.data.payload;

        try {
          const jsonData = JSON.parse(data); // Parse the string to JSON
          editor.import(jsonData);
        }
        catch (error) {
          console.error('Failed to parse JSON data:', error);
        }
      }
    });

    document.addEventListener('keydown', function (event) {
      // Check if the 'Ctrl' key and the 'Q' key were pressed
      if (event.ctrlKey && event.key === ' ') {
        event.preventDefault();
        const cleanedData = removeHtmlProperties(editor.export());
        Swal.fire({
          title: 'JSON',
          html: '<pre class="json-content">' + syntaxHighlight(JSON.stringify(cleanedData, null, 2)) + '</pre>'
        });
      }
    });

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<"']/g, function (m) {
        switch (m) {
          case '&':
            return '&amp;';
          case '<':
            return '&lt;';
          case '"':
            return '&quot;';
          case "'":
            return '&#39;';
          default:
            return m;
        }
      });
    }

    function removeHtmlProperties(obj) {
      if (Array.isArray(obj)) {
        return obj.map(removeHtmlProperties); // Recursively process each item in the array
      } else if (typeof obj === 'object' && obj !== null) {
        return Object.keys(obj).reduce((result, key) => {
          if (key !== 'html') { // Exclude the 'html' key
            result[key] = removeHtmlProperties(obj[key]); // Recursively process each property
          }
          return result;
        }, {});
      }
      return obj; // Return non-object values unchanged
    }

    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'key';
          } else {
            cls = 'string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'boolean';
        } else if (/null/.test(match)) {
          cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }
  </script>
</body>

</html>