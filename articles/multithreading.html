<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="lasR">
<title>Multi-threading in the lasR package â€¢ lasR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multi-threading in the lasR package">
<meta property="og:description" content="lasR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">lasR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/baba.html">Buffered Area Based Approach</a>
    <a class="dropdown-item" href="../articles/multithreading.html">Multi-threading in the lasR package</a>
    <a class="dropdown-item" href="../articles/lasR1.html">1. Why lasR?</a>
    <a class="dropdown-item" href="../articles/lasR2.html">2. Tutorial</a>
    <a class="dropdown-item" href="../articles/lasR3.html">3. Pipelines</a>
    <a class="dropdown-item" href="../articles/lasR4.html">4. Benchmarks of lasR vs. lidR</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lidar/lasR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Multi-threading in the lasR package</h1>
                        <h4 data-toc-skip class="author">Jean-Romain
Roussel</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lidar/lasR/blob/HEAD/vignettes/articles/multithreading.Rmd" class="external-link"><code>vignettes/articles/multithreading.Rmd</code></a></small>
      <div class="d-none name"><code>multithreading.Rmd</code></div>
    </div>

    
    
<p>The multi-threading in <code>lasR</code> is pretty similar to
<code>lidR</code>, except it does not use the package
<code>future</code>. Everything is natively coded in C++ with
<code>OpenMP</code>.</p>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px; font-size: 14px; border-radius: 5px;">
In the figures below, the pipelines are represented in an idealized and
simplified manner, with, for example, all stages taking the same amount
of time and all the cores running in parallel without any overhead.
While this simplification helps understanding, it does not capture the
entire actual complexity.
</blockquote>
<blockquote style="background-color: #f8d7da; border-left: 5px solid #dc3545; padding: 10px; font-size: 14px; border-radius: 5px;">
<code>lasR</code> uses <code>OpenMP</code> which means that the package
supports parallelism on Linux and Windows but not on macOS where Apple
has explicitly disabled <code>OpenMP</code> support in compilers that
they ship in <code>Xcode</code>. Interested readers can read the
following links: <a href="https://mac.r-project.org/openmp/" class="external-link">OpenMP on
macOS</a>; <a href="https://www.btskinner.io/code/install-r-with-openblas-and-openmp-on-macos-mojave/" class="external-link">OpenBLAS
and OpenMP on macOS</a> ; <a href="https://github.com/Rdatatable/data.table/wiki/Installation#Enable-openmp-for-macos" class="external-link">Enable
OpenMP for macOS</a>
</blockquote>
<div class="section level2">
<h2 id="sequential-strategy">Sequential strategy<a class="anchor" aria-label="anchor" href="#sequential-strategy"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">sequential</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The sequential strategy is <strong>not</strong> the default strategy.
However, it is easier to start with this option to explain some
specificities of <code>lasR</code>. In sequential processing, as the
name indicates, the LAS/LAZ files are processed sequentially, and
nothing is parallelized. The point cloud from one file passes through
the pipeline while the other files are waiting to be processed. This is
represented in the figure below.</p>
<p><img src="sequential.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="concurrent-points-strategy">Concurrent points strategy<a class="anchor" aria-label="anchor" href="#concurrent-points-strategy"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu">conccurent_points</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Concurrent points is the default strategy. The LAS/LAZ files are
processed sequentially. The point cloud from one file passes through the
pipeline while the other files are waiting. Inside the pipeline, some
stages are parallelized and are processing the points in different
threads. Each core processes a subset of the point cloud. The stages
that are parallelized are consequently faster, but in practice, not a
lot of stages can easily be parallelized this way.</p>
<p><img src="concurent_points.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="concurrent-files-strategy">Concurrent files strategy<a class="anchor" aria-label="anchor" href="#concurrent-files-strategy"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu">conccurent_files</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The LAS/LAZ files are processed in parallel. The point cloud from
several files passes through several cloned pipelines while the other
files are waiting. Inside the pipeline, the stages are not parallelized.
This puts a lot of pressure on the disk because many LAS/LAZ files are
read simultaneously, but also each stage can write some
raster/vector/LAS files simultaneously. Additionally, it uses a lot of
memory since many LAS files are loaded in memory simultaneously. With
modern and fast SSD disks and a significant amount of RAM, this is the
fastest option. Of course, users <strong>should not</strong> use all
their cores; otherwise, they may run out of memory. See also the <a href="../benchmarks.html">benchmarks</a> vignette.</p>
<p><img src="concurent_files.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="nested-strategy">Nested strategy<a class="anchor" aria-label="anchor" href="#nested-strategy"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">nested</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The LAS/LAZ files are processed in parallel. The point cloud from
several files passes through several cloned pipelines while the other
files are waiting. Inside the pipeline, some stages are also
parallelized and are processing the points in different threads.</p>
<p><img src="nested.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="special-cases">Special cases<a class="anchor" aria-label="anchor" href="#special-cases"></a>
</h2>
<p>In <code>lasR</code>, everything is written in pure C++ except for
two stages that inject user-defined R code and use the R C API.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fu">user_function</span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="fu">user_function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>R is <strong>NOT</strong> multi-threaded, and thus calling these
stages in parallel is not thread-safe and will crash the R session in
the best case or deeply corrupt the R memory in the worst case.
Consequently, these stages are protected and cannot run concurrently.
When a pipeline has stages that use the R API (in orange in the figure
below), the stages that use R are blocking the other stages that are
waiting (see figure below).</p>
<p><img src="concurent_points_with_R.png" width="600"></p>
<p>Of course, as depicted in the diagram above, this incurs a
computational time cost. Therefore, users are discouraged from using
these stages if alternatives are available. For example,
<code><a href="../reference/rasterize.html">rasterize()</a></code> offers numerous native metrics coded in C++,
making custom metrics coded in R unnecessary.</p>
<p>It is worth mentioning that the <code>lidR</code> package does not
face this problem because each core runs a different and independent R
session, thanks to the <code>future</code> package. While this approach
has some advantages, such as the one mentioned, it also comes with
several inconveniences and overheads. In contrast, <code>lasR</code>
utilizes only one R session to process multiple files in parallel.</p>
<p>With multiple files, the overhead of blocking the pipeline for stages
that use R is likely less significant because once the pipelines are out
of sync, the blocking stages no longer occur simultaneously and thus
cease to be blocking, as illustrated in the figure below with 8 files
and 4 cores</p>
<p><img src="concurent_points_with_R_8.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jean-Romain Roussel.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
